'use strict';
const bcrypt = require('bcryptjs');
const models = require('../models');
module.exports = (sequelize, DataTypes) => {
    const User = sequelize.define('User', {
        Username: DataTypes.STRING,
        Name: DataTypes.STRING,
        Email: {
            type: DataTypes.STRING,
            isEmail: true,
            unique: true
        },
        Position: DataTypes.STRING,
        Phone: DataTypes.STRING,
        Birthday: DataTypes.DATEONLY,
        Password: DataTypes.STRING,
        Photo: {
            type: DataTypes.STRING,
            defaultValue: "default.png"
        },
        isActive: {
            type: DataTypes.BOOLEAN,
            defaultValue: true
        },
        isAdmin: {
            type: DataTypes.BOOLEAN,
            defaultValue: false
        },
        ActiveHash: DataTypes.STRING,
        RememberHash: DataTypes.STRING

    }, {
        classMethods: {
            comparePassword: async function (Password, hash) {
                await bcrypt.compare(Password, hash, function (err, isMatch) {
                    return isMatch;
                });
            }
        },

    });


    User.associate = function (models) {
        // associations can be defined here
    };
    // This hook is called when an entry is being added to the back end.
    // This method is used to hash the password before storing it
    // in our database.
    User.beforeCreate((User, options) => {
        return bcrypt.genSalt(10).then(async salt => {
            await bcrypt.hash(User.Password, salt).then(async hash => {
                    User.Password = hash;
                }
            ).catch(err => {
                throw new Error();
            })
        }).catch(err => {
            throw new Error();
        })

    });
    User.beforeUpdate((User, options) => {
        // if(User.Password.length > 6)
        // {
        //     return bcrypt.genSalt(10).then(async salt => {
        //         await bcrypt.hash(User.Password, salt).then(async hash => {
        //                 User.Password = hash;
        //             }
        //         ).catch(err => {
        //             throw new Error();
        //         })
        //     }).catch(err => {
        //         throw new Error();
        //     })
        // }


    });
    User.prototype.comparePass = function (password) {
        console.log("From Model: " + password);
        return bcrypt.compareSync(password, this.Password);
    };

    return User;
};